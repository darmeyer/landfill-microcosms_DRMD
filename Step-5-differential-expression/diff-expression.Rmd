---
title: "differential-expression"
author: "Judy-Malas"
date: "12/22/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-physeq-objects-from-step4}

ps_all <- readRDS( "~/landfill-microcosms/data/live_samples_objects/ps_all.step4")
vst_all <- readRDS("~/landfill-microcosms/data/live_samples_objects/vst_all.step4")


ps_killed.rmt7 <- readRDS("~/landfill-microcosms/data/killed_microcosms_objects/ps_killed.rmt7")
vst_killed.rmt7<- readRDS("~/landfill-microcosms/data/killed_microcosms_objects/vst_killed.rmt7")

ps_killed <- readRDS("~/landfill-microcosms/data/killed_microcosms_objects/ps_killed.step4")
vst_killed <- readRDS("~/landfill-microcosms/data/killed_microcosms_objects/vst_killed.step4")



```

```{r load-packages}
library(DESeq2)
```

```{r psmelt}
ps_all.df <- psmelt(ps_all)

```


## DESEQ2 

```{r subset-each-spike}

antibiotics <- ps_all %>% 
  subset_samples(
    spike == "Antibiotics", 
  )

antibiotics <- antibiotics %>% 
  subset_samples(sample_time %in% c("T3",  "T6"))

sample_data(antibiotics)

```



```{r run-DESEQ}

levels(sample_data(antibiotics)$treatment)

ds_antibiotics <- phyloseq_to_deseq2(antibiotics, ~ treatment)

dds_antibiotics <- DESeq(ds_antibiotics, test = "Wald")

```


```{r results}

res_ab <- results(dds_antibiotics, cooksCutoff = F)
alpha = 0.05 

sigtab <- res_ab[which(res_ab$padj < alpha), ]

sigtab <- cbind(as(sigtab, "data.frame"), as(tax_table(antibiotics)[rownames(sigtab), ], "matrix"))

head(sigtab)


```
```{r check-Rummeliibacillus}

ps_all.df %>% 
  filter(spike == "Antibiotics", 
         Genus == "Rummeliibacillus") %>% 
  ggplot(aes(sample_time, Abundance)) +
  geom_point()


```
```{r}

ps_all.df %>% 
  filter(spike == "Antibiotics", 
         Class == "Clostridia") %>% 
  ggplot(aes(sample_time, Abundance)) +
  geom_point()

```

