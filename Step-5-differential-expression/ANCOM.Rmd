---
title: "ANCOM"
author: "Judy-Malas"
date: "12/28/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## ANCOM
(Kaul et al., 2017)
https://www.frontiersin.org/articles/10.3389/fmicb.2017.02114/full


The function rel_ancom defined in the file “rel_ancom.R”" relies on a series of internal functions
normalizer_gm, normalizer_ref, pop_detect, reset_dat_missing and struc_zero defined in the files,
geom_ref.R, pop_detect.R, stepA2.R and step A1.R respectively. All these files, along with the sample
data “otu.csv” and “meta.csv” should be stored in the working directory before proceeding. The analysis can
be then be implemented as follows.
```{r load-ANCOM}

source("rel_ancom.R")

```
Input data according to the format used in the sample data files provided along with the R script. Specifically,
one needs to provide two .csv files. 
The first containing the OTU counts data where one column is the “Sample.ID” and the all other columns are OTU counts corresponding to each id in the Sample ID column.

The second file is the metadata file, where, again one column is the “Sample.ID” and the others contain
various variables corresponding to each id, including the experimental group/population the id belongs to.
For illustration purposes we are providing the publicly available microbiome data of Yatsunenko et al. (2012).
```{r make-csv-files}

seqtab.ps_all <- ps_all@otu_table #extract the seq tab
metadata.ps_all <- ps_all@sam_data #extract the metadata table

otu_counts <- as.data.frame(seqtab.ps_all)

otu_counts <- otu_counts %>% 
  mutate(Sample.ID = rownames(otu_counts))

otu_counts$Sample.ID #check the new column was added 

write_csv(otu_counts,"otu_counts.csv")

otu <- read.csv("otu_counts.csv", skip = 1)  #this is the first file needed

meta <- as.data.frame(metadata.ps_all)

meta$Sample.ID <- meta$sample #this is the second file needed

identical(meta$Sample.ID, otu$Sample.ID) #should be true 

write_csv(meta, "meta.csv")

meta <- read.csv("meta.csv")

```

```{r run_ancom}

rel_ancom(OTUdat = otu, Vardat = meta, main.var = "treatment")

```




#ANCOM v2
https://github.com/FrederickHuangLin/ANCOM

```{r}
library(nlme)
library(tidyverse)
library(ggplot2)
library(compositions)
library(readr)
library(tidyverse)
```


```{r load-ancomv2}

source("scripts/ancom_v2.1.R")

```

```{r step1-datapreprocessing}

feature_table = otu; sample_var = "Sample.ID"; group_var = NULL

out_cut = 0.05; zero_cut = 0.90; lib_cut = 1000; neg_lb = FALSE

prepro = feature_table_pre_process(feature_table, meta, sample_var, group_var, 
                                   out_cut, zero_cut, lib_cut, neg_lb)

feature_table = prepro$feature_table # Preprocessed feature table

meta_data = prepro$meta # Preprocessed metadata

struc_zero = prepro$structure_zeros # Structural zero info

```

```{r step2}

main_var = "treatment"; p_adj_method = "BH"; alpha = 0.05
adj_formula = NULL; rand_formula = NULL
t_start = Sys.time()

res = ANCOM(feature_table = otu, meta_data = meta, main_var = "treatment")

t_end = Sys.time()
t_run = t_end - t_start # around 30s

write_csv(res$out, "outputs/res_moving_pics.csv")

```


